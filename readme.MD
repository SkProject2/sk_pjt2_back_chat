# Re:Use Chat Service

> ì‹¤ì‹œê°„ ì¤‘ê³ ê±°ë˜ í”Œë«í¼ì„ ìœ„í•œ WebSocket(STOMP) + Kafka ê¸°ë°˜ ë¶„ì‚° ì±„íŒ… ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤

## ğŸš€ Overview

Re:Use ì¤‘ê³ ê±°ë˜ í”Œë«í¼ì˜ í•µì‹¬ ì±„íŒ… ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. WebSocketê³¼ STOMP í”„ë¡œí† ì½œì„ í™œìš©í•œ ì‹¤ì‹œê°„ ì–‘ë°©í–¥ í†µì‹ ì„ ì œê³µí•˜ë©°, **Kafkaë¥¼ í†µí•œ ì„œë²„ê°„ ë©”ì‹œì§€ ë™ê¸°í™”**ë¡œ ì™„ì „í•œ ë¶„ì‚° ì•„í‚¤í…ì²˜ë¥¼ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### âœ¨ Key Features

- **ğŸ”„ ì‹¤ì‹œê°„ ì±„íŒ…**: WebSocket + STOMP ê¸°ë°˜ ì¦‰ì„ ë©”ì‹œì§•
- **ğŸŒ ë¶„ì‚° ì„œë²„ ì§€ì›**: Kafkaë¥¼ í†µí•œ ë©€í‹°ì„œë²„ ë©”ì‹œì§€ ë™ê¸°í™”
- **ğŸ“± 1:1 ì±„íŒ…ë°©**: êµ¬ë§¤ì-íŒë§¤ì ê°„ ê°œë³„ ì±„íŒ…ë°© ìë™ ìƒì„±
- **ğŸ’¾ ì±„íŒ… íˆìŠ¤í† ë¦¬**: MySQL ê¸°ë°˜ ì±„íŒ… ê¸°ë¡ ì˜êµ¬ ì €ì¥
- **âš¡ ì„¸ì…˜ ê´€ë¦¬**: Redisë¥¼ í™œìš©í•œ ì‹¤ì‹œê°„ ì‚¬ìš©ì ì„¸ì…˜ ì¶”ì  (JSON ê¸°ë°˜)
- **ğŸ”— í™•ì¥ì„±**: ì„œë²„ ê°œìˆ˜ì— ìƒê´€ì—†ì´ ëª¨ë“  ì‚¬ìš©ì ê°„ ì‹¤ì‹œê°„ í†µì‹ 
- **ğŸ“§ ë¬¸ì˜ ê¸°ëŠ¥**: JavaMailì„ í†µí•œ ê³ ê° ë¬¸ì˜ ì²˜ë¦¬

---

## ğŸ› ï¸ Tech Stack

### Backend
- **Java 17** - Core Language
- **Spring Boot 3.4.2** - Application Framework
- **Spring WebSocket & STOMP** - Real-time Client Communication
- **Spring Data JPA** - Data Access

### Infrastructure
- **MySQL** - Chat History & Room Management
- **Redis** - Session Store & User Tracking (JSON Format)
- **Apache Kafka** - Message Queue & Inter-service Communication
- **Docker Compose** - Development Environment

### DevOps
- **GitHub Actions** - CI/CD Pipeline
- **AWS EC2** - Production Deployment
- **Gradle** - Build & Dependency Management

---

## ğŸ—ï¸ Architecture

### ë¶„ì‚° ì±„íŒ… ì•„í‚¤í…ì²˜
```
[í´ë¼ì´ì–¸íŠ¸A] â”€â”€STOMPâ”€â”€â†’ [ì„œë²„1] â”€â”€Kafkaâ”€â”€â†’ [Kafka Broker] â”€â”€Kafkaâ”€â”€â†’ [ì„œë²„2] â”€â”€STOMPâ”€â”€â†’ [í´ë¼ì´ì–¸íŠ¸B]
     â†‘                     â†“                                     â†“                     â†‘
  WebSocket            Producer                               Consumer              WebSocket
     â†‘                     â†“                                     â†“                     â†‘
localhost:8070         MySQL ì €ì¥                          MySQL ì¡°íšŒ           localhost:8071
                       Redis ì„¸ì…˜                          Redis ì„¸ì…˜
```

### í•µì‹¬ êµ¬ì„±ìš”ì†Œ

#### 1. **STOMP (í´ë¼ì´ì–¸íŠ¸ â†” ì„œë²„)**
- WebSocket ê¸°ë°˜ ì‹¤ì‹œê°„ ì–‘ë°©í–¥ í†µì‹ 
- í´ë¼ì´ì–¸íŠ¸ì™€ ê° ì„œë²„ ê°„ ì—°ê²° ìœ ì§€
- ë©”ì‹œì§€ ìˆ˜ì‹  ë° ì „ë‹¬

#### 2. **Kafka (ì„œë²„ â†” ì„œë²„)**
- ì„œë²„ ê°„ ë©”ì‹œì§€ ë™ê¸°í™”
- ëª¨ë“  ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
- ë©”ì‹œì§€ ì˜ì†ì„± ë° í™•ì¥ì„± ë³´ì¥

#### 3. **Redis (ì„¸ì…˜ ê´€ë¦¬)**
- JSON í˜•íƒœì˜ ì‚¬ìš©ì ì„¸ì…˜ ì •ë³´ ì €ì¥
- ì„œë²„ë³„ ì ‘ì† ì‚¬ìš©ì ì¶”ì 
- ì‹¤ì‹œê°„ ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬

---

## ğŸ—‚ï¸ Project Structure

```
src/main/java/com/example/sk_pjt2_back_chat/
â”œâ”€â”€ ğŸ“ config/           # ì„¤ì • íŒŒì¼ë“¤
â”‚   â”œâ”€â”€ SecurityConfig.java
â”‚   â”œâ”€â”€ WebSocketConfig.java      # STOMP ì„¤ì •
â”‚   â””â”€â”€ RedisConfig.java          # JSON ì§ë ¬í™” ì„¤ì •
â”œâ”€â”€ ğŸ“ controller/       # REST & WebSocket ì»¨íŠ¸ë¡¤ëŸ¬
â”‚   â”œâ”€â”€ ChatController.java       # ì±„íŒ… + ë””ë²„ê·¸ API
â”‚   â”œâ”€â”€ RoomController.java       # ì±„íŒ…ë°© ê´€ë¦¬
â”‚   â””â”€â”€ InquiryController.java    # ë¬¸ì˜ ì²˜ë¦¬
â”œâ”€â”€ ğŸ“ service/          # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”œâ”€â”€ ChatService.java          # Kafka Producer/Consumer
â”‚   â”œâ”€â”€ RoomService.java          # ì±„íŒ…ë°© ì„œë¹„ìŠ¤
â”‚   â””â”€â”€ UserSessionService.java   # Redis ì„¸ì…˜ ê´€ë¦¬ (JSON)
â”œâ”€â”€ ğŸ“ entity/           # JPA ì—”í‹°í‹°
â”‚   â”œâ”€â”€ Chat.java                 # ì±„íŒ… ë©”ì‹œì§€
â”‚   â”œâ”€â”€ Room.java                 # ì±„íŒ…ë°©
â”‚   â””â”€â”€ RoomUser.java             # ì±„íŒ…ë°©-ì‚¬ìš©ì ë§¤í•‘
â”œâ”€â”€ ğŸ“ dto/              # ë°ì´í„° ì „ì†¡ ê°ì²´
â”œâ”€â”€ ğŸ“ repository/       # ë°ì´í„° ì•¡ì„¸ìŠ¤ ê³„ì¸µ
â””â”€â”€ ğŸ“ interceptor/      # STOMP ì¸í„°ì…‰í„°
    â””â”€â”€ StompInterceptor.java     # ì„¸ì…˜ ID ê¸°ë°˜ ì—°ê²°/í•´ì œ ì²˜ë¦¬
```

---

## ğŸ”„ Message Flow

### ë©€í‹°ì„œë²„ ì±„íŒ… ë©”ì‹œì§€ íë¦„

1. **ì‚¬ìš©ì A (ì„œë²„1)** â†’ **ë©”ì‹œì§€ ì „ì†¡** â†’ **STOMP ìˆ˜ì‹ **
2. **ì„œë²„1** â†’ **MySQL ì €ì¥** + **Kafka Producer**ë¡œ ë°œí–‰
3. **Kafka Broker** â†’ **ëª¨ë“  ì„œë²„**ì— ë©”ì‹œì§€ ì „íŒŒ
4. **ê° ì„œë²„** â†’ **í•´ë‹¹ ì„œë²„ ì ‘ì† ì‚¬ìš©ì í™•ì¸** (Redis ì¡°íšŒ)
5. **ì ‘ì† ì‚¬ìš©ì ìˆëŠ” ì„œë²„** â†’ **STOMPë¡œ ì‹¤ì‹œê°„ ì „ì†¡**
6. **ì‚¬ìš©ì B (ì„œë²„2)** â†’ **ì¦‰ì‹œ ë©”ì‹œì§€ ìˆ˜ì‹ **

### ì„¸ì…˜ ê´€ë¦¬ íë¦„

1. **WebSocket ì—°ê²°** â†’ `StompInterceptor`ê°€ ê°ì§€
2. **Redis ì €ì¥** â†’ JSON í˜•íƒœì˜ ì„¸ì…˜ ì •ë³´ (ì„œë²„ID, URL, ì ‘ì†ì‹œê°„ ë“±)
3. **ì—°ê²° í•´ì œ** â†’ ì„¸ì…˜ ID ê¸°ë°˜ìœ¼ë¡œ ì•ˆì „í•œ ì •ë¦¬

---

## ğŸŒ Multi-Server Support

### ì„œë²„ë³„ ì„¤ì •
```yaml
# Server 1
server:
  id: chat-server-1
  port: 8070

# Server 2  
server:
  id: chat-server-2
  port: 8071
```

### Kafka Consumer Group
```java
@KafkaListener(topics = "chat", groupId = "team5-${server.id}")
```
- ê° ì„œë²„ë³„ë¡œ ë‹¤ë¥¸ Consumer Group
- ëª¨ë“  ì„œë²„ê°€ ë™ì¼í•œ ë©”ì‹œì§€ ìˆ˜ì‹ 
- ì„œë²„ë³„ ë…ë¦½ì ì¸ ë©”ì‹œì§€ ì²˜ë¦¬

### Redis ì„¸ì…˜ êµ¬ì¡°
```json
{
  "userId": "user123",
  "sessionId": "session-abc-123", 
  "serverId": "chat-server-1",
  "serverHost": "localhost",
  "serverPort": "8070",
  "serverUrl": "ws://localhost:8070/ws-stomp",
  "connectTime": "2025-01-20T10:30:00",
  "lastActiveTime": "2025-01-20T10:35:00"
}
```

---

## ğŸ” Debug & Monitoring

### ì‹¤ì‹œê°„ ì„¸ì…˜ í˜„í™© API

- **ğŸ“Š ì „ì²´ ì„¸ì…˜ í˜„í™©**: ì„œë²„ë³„ ì ‘ì† ì‚¬ìš©ì ë¶„í¬
- **ğŸ‘¤ ë‚´ ì„¸ì…˜ ì •ë³´**: ê°œë³„ ì‚¬ìš©ì ì„¸ì…˜ ìƒì„¸ ì •ë³´
- **ğŸ” ì„œë²„ ìƒíƒœ í™•ì¸**: ì„œë²„ ì‘ë‹µì„± í…ŒìŠ¤íŠ¸
- **ì‹¤ì‹œê°„ ë¡œê·¸**: íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨ ìƒì„¸ ë¡œê¹…

---