<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ë©€í‹°ì„œë²„ ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .server-section {
            background: #e3f2fd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
        }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 100px;
            font-weight: bold;
        }
        input[type="text"], select {
            padding: 5px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            background: #2196f3;
            color: white;
        }
        button:hover {
            background: #1976d2;
        }
        button.disconnect {
            background: #f44336;
        }
        button.disconnect:hover {
            background: #d32f2f;
        }
        #monitor {
            border: 1px solid #ddd;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            background: #fafafa;
            font-family: monospace;
            margin-top: 20px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
        }
        .connected {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .disconnected {
            background: #ffcdd2;
            color: #c62828;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸš€ ë©€í‹°ì„œë²„ ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>

    <div class="server-section">
        <h3>ğŸ“¡ ì„œë²„ ì—°ê²° ì„¤ì •</h3>
        <div class="input-group">
            <label>ì„œë²„ ì„ íƒ:</label>
            <select id="serverSelect">
                <option value="localhost:8070">Chat Server 1 (Port 8070)</option>
                <option value="localhost:8071">Chat Server 2 (Port 8071)</option>
                <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
            </select>
        </div>

        <div class="input-group" id="customServerDiv" style="display: none;">
            <label>ì„œë²„ ì£¼ì†Œ:</label>
            <input id="customServer" type="text" placeholder="localhost:8072">
        </div>

        <div class="input-group">
            <label>ë°© UUID:</label>
            <input id="roomId" type="text" placeholder="ë°© UUID ì…ë ¥">
        </div>

        <div class="input-group">
            <label>ì‚¬ìš©ìëª…:</label>
            <input id="sender" type="text" placeholder="ì‚¬ìš©ì ì´ë¦„ ì…ë ¥">
        </div>

        <div>
            <button id="btn1" onclick="sub()">ğŸ”— ì—°ê²°</button>
            <button id="btn2" onclick="unsub()" class="disconnect">âŒ ì—°ê²°í•´ì œ</button>
            <span id="connectionStatus" class="status disconnected">ì—°ê²° ì•ˆë¨</span>
        </div>
    </div>

    <div class="server-section">
        <h3>ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡</h3>
        <div class="input-group">
            <input id="content" type="text" placeholder="ë³´ë‚¼ ë©”ì‹œì§€" style="width: 60%;">
            <button onclick="send()">ğŸ“¤ ì „ì†¡</button>
        </div>
    </div>

    <div class="server-section">
        <h3>ğŸ” ë””ë²„ê·¸ & ëª¨ë‹ˆí„°ë§</h3>
        <button onclick="checkAllSessions()">ğŸ“Š ì „ì²´ ì„¸ì…˜ í˜„í™©</button>
        <button onclick="checkMySession()">ğŸ‘¤ ë‚´ ì„¸ì…˜ ì •ë³´</button>
        <button onclick="checkServerStatus()">ğŸ” ì„œë²„ ìƒíƒœ í™•ì¸</button>
        <button onclick="clearMonitor()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <div class="server-section">
        <h3>ğŸ“œ ì±„íŒ… ë¡œê·¸</h3>
        <div id="monitor"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
<script>
    let stompClient = null;
    let currentServer = null;

    // ì„œë²„ ì„ íƒ ë³€ê²½ ì‹œ
    document.getElementById('serverSelect').addEventListener('change', function() {
        const customDiv = document.getElementById('customServerDiv');
        if (this.value === 'custom') {
            customDiv.style.display = 'block';
        } else {
            customDiv.style.display = 'none';
        }
    });

    // ì—”í„°í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('content').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            send();
        }
    });

    function getSelectedServer() {
        const serverSelect = document.getElementById('serverSelect');
        if (serverSelect.value === 'custom') {
            return document.getElementById('customServer').value || 'localhost:8070';
        }
        return serverSelect.value;
    }

    function getServerUrl(server) {
        return `ws://${server}/ws-stomp`;
    }

    function getApiUrl(server) {
        return `http://${server}`;
    }

    function updateConnectionStatus(connected, server = null) {
        const status = document.getElementById('connectionStatus');
        if (connected) {
            status.className = 'status connected';
            status.textContent = `ì—°ê²°ë¨: ${server}`;
        } else {
            status.className = 'status disconnected';
            status.textContent = 'ì—°ê²° ì•ˆë¨';
        }
    }

    function addToMonitor(message, type = 'info') {
        const monitor = document.getElementById('monitor');
        const timestamp = new Date().toLocaleTimeString();
        const colorMap = {
            'info': '#333',
            'success': '#4caf50',
            'error': '#f44336',
            'warning': '#ff9800',
            'message': '#2196f3'
        };

        monitor.innerHTML += `<div style="color: ${colorMap[type]};">[${timestamp}] ${message}</div>`;
        monitor.scrollTop = monitor.scrollHeight;
    }

    async function sub() {
        const roomId = document.getElementById('roomId').value;
        const sender = document.getElementById('sender').value;

        if (!roomId || !sender) {
            addToMonitor('âŒ ë°© UUIDì™€ ì‚¬ìš©ìëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        try {
            currentServer = getSelectedServer();
            const wsUrl = getServerUrl(currentServer);
            const apiUrl = getApiUrl(currentServer);

            addToMonitor(`ğŸ”„ ${currentServer} ì„œë²„ì— ì—°ê²° ì‹œë„ ì¤‘...`, 'info');

            // WebSocket ì—°ê²°
            stompClient = Stomp.client(wsUrl);
            const header = { 'sender': sender };

            stompClient.connect(header, function(frame) {
                addToMonitor(`âœ… WebSocket ì—°ê²° ì„±ê³µ: ${currentServer}`, 'success');
                updateConnectionStatus(true, currentServer);

                // ë°© ì¡´ì¬ í™•ì¸ ë° ì…ì¥
                checkRoomAndSubscribe(roomId, sender, apiUrl);

            }, function(error) {
                addToMonitor(`âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ${error}`, 'error');
                updateConnectionStatus(false);
            });

        } catch (error) {
            addToMonitor(`âŒ ì—°ê²° ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
            updateConnectionStatus(false);
        }
    }

    async function checkRoomAndSubscribe(roomId, sender, apiUrl) {
        try {
            // ë°© ì¡´ì¬ í™•ì¸
            const response = await axios.get(`${apiUrl}/room/${roomId}`, {
                headers: {"X-Auth-User": sender}
            });

            const room = response.data.room.roomUUID;
            if (room === roomId) {
                // ë°© êµ¬ë…
                stompClient.subscribe(`/sub/chat/room/${roomId}`, chatting, {id: `cus-${roomId}`});
                addToMonitor(`ğŸ“¡ ì±„íŒ…ë°© êµ¬ë… ì™„ë£Œ: ${roomId}`, 'success');

                // ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ
                loadChatHistory(roomId, apiUrl);
            } else {
                addToMonitor('âŒ ë°© ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            }

        } catch (error) {
            addToMonitor(`âŒ ë°© ì ‘ê·¼ ì‹¤íŒ¨: ${error.message}`, 'error');
            addToMonitor('ğŸ’¡ ë°©ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        }
    }

    async function loadChatHistory(roomId, apiUrl) {
        try {
            const response = await axios.get(`${apiUrl}/chat/room/${roomId}`);
            addToMonitor('ğŸ“œ ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë”©...', 'info');

            response.data.forEach(function(data) {
                addToMonitor(`ğŸ’¬ ${data.sender}: ${data.content}`, 'message');
            });

            addToMonitor('âœ… ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë”© ì™„ë£Œ', 'success');
        } catch (error) {
            addToMonitor('âŒ ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë”© ì‹¤íŒ¨', 'error');
        }
    }

    function chatting(response) {
        if (response.body) {
            const res = JSON.parse(response.body);
            addToMonitor(`ğŸ’¬ ${res.sender}: ${res.content}`, 'message');
        }
    }

    function unsub() {
        if (stompClient) {
            const roomId = document.getElementById('roomId').value;
            if (roomId) {
                stompClient.unsubscribe(`cus-${roomId}`);
            }

            stompClient.disconnect(function() {
                addToMonitor('ğŸ”Œ ì—°ê²° í•´ì œë¨', 'warning');
                updateConnectionStatus(false);
            });

            stompClient = null;
            currentServer = null;
        }
    }

    function send() {
        if (!stompClient || !currentServer) {
            addToMonitor('âŒ ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        const roomUUID = document.getElementById('roomId').value;
        const sender = document.getElementById('sender').value;
        const content = document.getElementById('content').value;

        if (!content.trim()) {
            addToMonitor('âŒ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const message = {
            'roomUUID': roomUUID,
            'sender': sender,
            'content': content
        };

        try {
            stompClient.send(`/pub/room/${roomUUID}/message`, {}, JSON.stringify(message));
            document.getElementById('content').value = '';
            addToMonitor(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡ë¨: ${content}`, 'info');
        } catch (error) {
            addToMonitor(`âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    function clearMonitor() {
        document.getElementById('monitor').innerHTML = '';
        addToMonitor('ğŸ—‘ï¸ ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.', 'info');
    }

    async function checkServerStatus() {
        const server = getSelectedServer();
        const apiUrl = getApiUrl(server);

        try {
            addToMonitor(`ğŸ” ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘: ${server}`, 'info');
            const response = await axios.get(`${apiUrl}/chat/test`, { timeout: 5000 });
            addToMonitor(`âœ… ì„œë²„ ì‘ë‹µ: ${response.data}`, 'success');
        } catch (error) {
            addToMonitor(`âŒ ì„œë²„ ì‘ë‹µ ì—†ìŒ: ${server}`, 'error');
        }
    }

    // ì „ì²´ ì„¸ì…˜ í˜„í™© ì¡°íšŒ
    async function checkAllSessions() {
        const server = getSelectedServer();
        const apiUrl = getApiUrl(server);

        try {
            addToMonitor(`ğŸ“Š ì „ì²´ ì„¸ì…˜ í˜„í™© ì¡°íšŒ ì¤‘...`, 'info');
            const response = await axios.get(`${apiUrl}/chat/debug/sessions`, { timeout: 10000 });
            const data = response.data;

            addToMonitor(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');
            addToMonitor(`ğŸ“Š ì„¸ì…˜ í˜„í™© ë¦¬í¬íŠ¸ (${data.timestamp})`, 'success');
            addToMonitor(`ğŸ–¥ï¸ í˜„ì¬ ì¡°íšŒ ì„œë²„: ${data.currentServerId}`, 'info');

            // ì„œë²„ë³„ ì‚¬ìš©ì í˜„í™©
            addToMonitor(`\nğŸŒ ì„œë²„ë³„ ì ‘ì† ì‚¬ìš©ì:`, 'info');
            if (data.serverUsers && Object.keys(data.serverUsers).length > 0) {
                for (const [serverId, users] of Object.entries(data.serverUsers)) {
                    addToMonitor(`  â”œâ”€ ${serverId}: [${Array.from(users).join(', ')}]`, 'message');
                }
            } else {
                addToMonitor(`  â””â”€ ì ‘ì†í•œ ì‚¬ìš©ì ì—†ìŒ`, 'warning');
            }

            // í˜„ì¬ ì„œë²„ ì‚¬ìš©ì
            addToMonitor(`\nğŸ  í˜„ì¬ ì„œë²„(${data.currentServerId}) ì‚¬ìš©ì:`, 'info');
            if (data.currentServerUsers && data.currentServerUsers.length > 0) {
                addToMonitor(`  â””â”€ [${Array.from(data.currentServerUsers).join(', ')}]`, 'success');
            } else {
                addToMonitor(`  â””â”€ í˜„ì¬ ì„œë²„ì— ì ‘ì†í•œ ì‚¬ìš©ì ì—†ìŒ`, 'warning');
            }

            // ì‚¬ìš©ìë³„ ìƒì„¸ ì •ë³´
            if (data.userDetails && Object.keys(data.userDetails).length > 0) {
                addToMonitor(`\nğŸ‘¥ ì‚¬ìš©ìë³„ ìƒì„¸ ì •ë³´:`, 'info');
                for (const [userId, details] of Object.entries(data.userDetails)) {
                    addToMonitor(`  â”œâ”€ ${userId}:`, 'message');
                    addToMonitor(`  â”‚  â”œâ”€ ì„œë²„: ${details.serverId}`, 'message');
                    addToMonitor(`  â”‚  â”œâ”€ URL: ${details.serverUrl}`, 'message');
                    addToMonitor(`  â”‚  â”œâ”€ ì ‘ì†ì‹œê°„: ${new Date(details.connectTime).toLocaleString()}`, 'message');
                    addToMonitor(`  â”‚  â””â”€ ë§ˆì§€ë§‰í™œë™: ${new Date(details.lastActiveTime).toLocaleString()}`, 'message');
                }
            }

            addToMonitor(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');

        } catch (error) {
            addToMonitor(`âŒ ì„¸ì…˜ í˜„í™© ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // ë‚´ ì„¸ì…˜ ì •ë³´ ì¡°íšŒ
    async function checkMySession() {
        const sender = document.getElementById('sender').value;
        if (!sender) {
            addToMonitor('âŒ ì‚¬ìš©ìëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        const server = getSelectedServer();
        const apiUrl = getApiUrl(server);

        try {
            addToMonitor(`ğŸ‘¤ ${sender} ì‚¬ìš©ì ì„¸ì…˜ ì •ë³´ ì¡°íšŒ ì¤‘...`, 'info');
            const response = await axios.get(`${apiUrl}/chat/debug/sessions/${sender}`, { timeout: 5000 });
            const data = response.data;

            if (data.sessionInfo) {
                addToMonitor(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');
                addToMonitor(`ğŸ‘¤ ${sender} ì„¸ì…˜ ì •ë³´:`, 'success');
                addToMonitor(`  â”œâ”€ ì„¸ì…˜ ID: ${data.sessionInfo.sessionId}`, 'message');
                addToMonitor(`  â”œâ”€ ì ‘ì† ì„œë²„: ${data.sessionInfo.serverId}`, 'message');
                addToMonitor(`  â”œâ”€ ì„œë²„ ì£¼ì†Œ: ${data.sessionInfo.serverHost}:${data.sessionInfo.serverPort}`, 'message');
                addToMonitor(`  â”œâ”€ WebSocket URL: ${data.sessionInfo.serverUrl}`, 'message');
                addToMonitor(`  â”œâ”€ ì ‘ì† ì‹œê°„: ${new Date(data.sessionInfo.connectTime).toLocaleString()}`, 'message');
                addToMonitor(`  â”œâ”€ ë§ˆì§€ë§‰ í™œë™: ${new Date(data.sessionInfo.lastActiveTime).toLocaleString()}`, 'message');
                addToMonitor(`  â””â”€ í˜„ì¬ ì„œë²„ì™€ ë™ì¼: ${data.isOnThisServer ? 'âœ…' : 'âŒ'}`, data.isOnThisServer ? 'success' : 'warning');
                addToMonitor(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, 'info');
            } else {
                addToMonitor(`âŒ ${sender} ì‚¬ìš©ìì˜ ì„¸ì…˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                addToMonitor(`ğŸ’¡ ë¨¼ì € ì„œë²„ì— ì—°ê²°í•´ì£¼ì„¸ìš”.`, 'warning');
            }

        } catch (error) {
            addToMonitor(`âŒ ì„¸ì…˜ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë©”ì‹œì§€
    window.addEventListener('load', function() {
        addToMonitor('ğŸ‰ ë©€í‹°ì„œë²„ ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨', 'success');
        addToMonitor('ğŸ’¡ ì„œë²„ë¥¼ ì„ íƒí•˜ê³  ë°© UUID, ì‚¬ìš©ìëª…ì„ ì…ë ¥í•œ í›„ ì—°ê²°í•˜ì„¸ìš”.', 'info');
    });
</script>
</body>
</html>